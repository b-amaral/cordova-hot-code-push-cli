{"version":3,"sources":["../src/build.js"],"names":[],"mappings":"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","file":"build.js","sourcesContent":["(function() {\r\n  var path = require('path'),\r\n    prompt = require('prompt'),\r\n    fs = require('fs-extra'),\r\n    async = require('async'),\r\n    crypto = require('crypto'),\r\n    Q = require('q'),\r\n    _ = require('lodash'),\r\n    createHash = require('crypto').createHash,\r\n    recursive = require('recursive-readdir'),\r\n    hidefile = require('hidefile'),\r\n    chcpContext;\r\n\r\n  module.exports = {\r\n    execute: execute\r\n  };\r\n\r\n  function execute(context) {\r\n    chcpContext = context;\r\n\r\n    var executeDfd = Q.defer(),\r\n      config = prepareConfig(context),\r\n      ignore = context.ignoredFiles;\r\n\r\n    recursive(chcpContext.sourceDirectory, ignore, function(err, files) {\r\n      var hashQueue = prepareFilesHashQueue(files);\r\n\r\n      async.parallelLimit(hashQueue, 10, function(err, result) {\r\n        result.sort((a, b) => {\r\n          return a.file.localeCompare(b.file)\r\n        });\r\n        var json = JSON.stringify(result, null, 2);\r\n        var manifestFile = chcpContext.manifestFilePath;\r\n\r\n        fs.writeFile(manifestFile, json, function(err) {\r\n          if (err) {\r\n            return console.log(err);\r\n          }\r\n\r\n          if (context.argv && context.argv.localdev) {\r\n            config.update = 'now';\r\n          }\r\n          var json = JSON.stringify(config, null, 2);\r\n          fs.writeFile(chcpContext.projectsConfigFilePath, json, function(err) {\r\n            if (err) {\r\n              return console.log(err);\r\n            }\r\n            console.log('Build ' + config.release + ' created in ' + chcpContext.sourceDirectory);\r\n            executeDfd.resolve(config);\r\n          });\r\n        });\r\n      });\r\n    });\r\n\r\n    return executeDfd.promise;\r\n  }\r\n\r\n  function prepareFilesHashQueue(files) {\r\n    var queue = [];\r\n    for (var i in files) {\r\n      var file = files[i];\r\n      if (!hidefile.isHiddenSync(file)) {\r\n        queue.push(hashFile.bind(null, file));\r\n      }\r\n    }\r\n\r\n    return queue;\r\n  }\r\n\r\n  function prepareConfig(context) {\r\n    var config = {};\r\n\r\n    try {\r\n      config = fs.readFileSync(context.defaultConfig, 'utf8');\r\n      config = JSON.parse(config);\r\n      config.release = process.env.VERSION || calculateTimestamp();\r\n    } catch (e) {\r\n      config = {\r\n        autogenerated: true,\r\n        release: calculateTimestamp()\r\n      };\r\n    }\r\n\r\n    if (context.argv && context.argv.content_url) {\r\n      config.content_url = context.argv.content_url;\r\n    }\r\n\r\n    console.log('Config', config);\r\n    return config;\r\n  }\r\n\r\n  function hashFile(filename, callback) {\r\n    var hash = crypto.createHash('md5'),\r\n      stream = fs.createReadStream(filename);\r\n\r\n    //stream.pipe(writeStream);\r\n    //console.log('Hashing: ', filename);\r\n    stream.on('data', function(data) {\r\n      hash.update(data, 'utf8');\r\n    });\r\n\r\n    stream.on('end', function() {\r\n      var result = hash.digest('hex'),\r\n        file = path.relative(chcpContext.sourceDirectory, filename).replace(new RegExp(\"\\\\\\\\\", \"g\"), \"/\");\r\n\r\n      callback(null, {\r\n        file: file,\r\n        hash: result\r\n      });\r\n    });\r\n  }\r\n\r\n  function calculateTimestamp() {\r\n    var currentdate = new Date();\r\n    return currentdate.getFullYear() + '.' +\r\n      (((currentdate.getMonth() + 1) < 10) ? '0' + (currentdate.getMonth() + 1) : (currentdate.getMonth() + 1)) + '.' +\r\n      ((currentdate.getDate() < 10) ? '0' + currentdate.getDate() : currentdate.getDate()) + '-' +\r\n      ((currentdate.getHours() < 10) ? '0' + currentdate.getHours() : currentdate.getHours()) + '.' +\r\n      ((currentdate.getMinutes() < 10) ? '0' + currentdate.getMinutes() : currentdate.getMinutes()) + '.' +\r\n      ((currentdate.getSeconds() < 10) ? '0' + currentdate.getSeconds() : currentdate.getSeconds());\r\n  }\r\n})();\r\n"]}